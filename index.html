<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll & Attendance Management System</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --color-primary: #217C8D;
            --color-primary-light: #32B8C6;
            --color-bg: #FCFCF9;
            --color-surface: #FFFFFF;
            --color-text: #134252;
            --color-text-light: #626C71;
            --color-border: #E8E8E4;
            --color-success: #20B80D;
            --color-warning: #E8A160;
            --color-error: #C01527;
            --color-info: #626C71;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h2 {
            color: var(--color-primary);
            margin-bottom: 30px;
            text-align: center;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-text);
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 124, 141, 0.1);
        }
        
        button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background-color: var(--color-primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 124, 141, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background-color: transparent;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }
        
        .btn-secondary:hover {
            background-color: rgba(33, 124, 141, 0.1);
        }
        
        .btn-danger {
            background-color: var(--color-error);
        }
        
        .btn-danger:hover {
            background-color: #A01223;
        }
        
        .btn-success {
            background-color: var(--color-success);
        }
        
        .btn-success:hover {
            background-color: #1a8f0a;
        }
        
        .btn-full {
            width: 100%;
        }
        
        .error-message {
            color: var(--color-error);
            background-color: rgba(192, 21, 47, 0.1);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            border-left: 4px solid var(--color-error);
        }
        
        .success-message {
            color: var(--color-success);
            background-color: rgba(32, 184, 13, 0.1);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            border-left: 4px solid var(--color-success);
        }
        
        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .nav button {
            padding: 10px 20px;
            font-size: 13px;
            background-color: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }
        
        .nav button.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        /* Dashboard Grid */
        .dashboard {
            display: none;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--color-border);
        }
        
        .card h2 {
            color: var(--color-primary);
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .card h3 {
            color: var(--color-text);
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
        }
        
        .stat-label {
            color: var(--color-text-light);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--color-primary);
        }
        
        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th {
            background-color: var(--color-primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
            font-size: 14px;
        }
        
        tr:hover {
            background-color: rgba(33, 124, 141, 0.05);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-present {
            background-color: rgba(32, 184, 13, 0.2);
            color: var(--color-success);
        }
        
        .status-absent {
            background-color: rgba(192, 21, 47, 0.2);
            color: var(--color-error);
        }
        
        .status-late {
            background-color: rgba(232, 161, 96, 0.2);
            color: var(--color-warning);
        }
        
        .status-leave {
            background-color: rgba(33, 124, 141, 0.2);
            color: var(--color-primary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: var(--color-primary);
            font-size: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-light);
        }
        
        .close-btn:hover {
            color: var(--color-text);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-container">
    <div class="login-box">
        <h2>üîê Payroll System</h2>
        <div id="loginError"></div>
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="Enter username" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="Enter password" required>
            </div>
            <button type="submit" class="btn-full">Login</button>
        </form>
        <p style="margin-top: 20px; text-align: center; color: var(--color-text-light); font-size: 12px;">
            Demo: admin/admin123 or user1/pass123
        </p>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display: none;">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üìä Payroll & Attendance System</h1>
                    <p id="userDisplay"></p>
                </div>
                <button onclick="logout()" class="btn-danger">Logout</button>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="nav" id="navMenu"></div>
        
        <!-- DASHBOARD: EMPLOYEES -->
        <div id="employeeDashboard" class="dashboard">
            <div class="card">
                <h2>üë• Employees</h2>
                <button onclick="showEmployeeModal()">+ Add Employee</button>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Salary</th>
                            <th>Shift</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- DASHBOARD: ATTENDANCE -->
        <div id="attendanceDashboard" class="dashboard">
            <div class="card">
                <h2>‚è∞ Attendance</h2>
                <button onclick="showAttendanceModal()">+ Record Attendance</button>
                <button onclick="showImportModal()" style="margin-left: 10px;">üì• Import CSV/Excel</button>
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Date</th>
                            <th>In Time</th>
                            <th>Out Time</th>
                            <th>Hours</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- DASHBOARD: PAYROLL -->
        <div id="payrollDashboard" class="dashboard">
            <div class="card">
                <h2>üí∞ Payroll</h2>
                <button onclick="generatePayroll()">Generate Monthly Payroll</button>
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Month</th>
                            <th>Days</th>
                            <th>Gross Pay</th>
                            <th>Deductions</th>
                            <th>Net Pay</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="payrollTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- DASHBOARD: ANALYTICS -->
        <div id="analyticsDashboard" class="dashboard">
            <div class="card">
                <h2>üìà Analytics</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Total Employees</div>
                        <div class="stat-value" id="statTotalEmployees">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Present Today</div>
                        <div class="stat-value" id="statPresentToday">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Absent Today</div>
                        <div class="stat-value" id="statAbsentToday">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Avg Attendance %</div>
                        <div class="stat-value" id="statAvgAttendance">0%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- DASHBOARD: CLOUD STORAGE -->
        <div id="cloudStorageDashboard" class="dashboard">
            <div class="card">
                <h2>‚òÅÔ∏è Google Drive Backup</h2>
                <button onclick="backupToGoogleDrive()">üíæ Backup Data</button>
                <button onclick="restoreFromGoogleDrive()" class="btn-secondary" style="margin-left: 10px;">üìÇ Restore Data</button>
                <p style="margin-top: 15px; font-size: 12px; color: #666;">
                    ‚úÖ All data encrypted before backup<br>
                    ‚úÖ No Google API needed (manual backup/restore)<br>
                    ‚úÖ Download .dat file and keep it safe
                </p>
            </div>
        </div>
        
        <!-- DASHBOARD: USERS (Admin Only) -->
        <div id="usersDashboard" class="dashboard">
            <div class="card">
                <h2>üë§ Manage Users</h2>
                <button onclick="showUserModal()">+ Add User</button>
                <table>
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->

<!-- Add Employee Modal -->
<div id="employeeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Employee</h2>
            <button class="close-btn" onclick="closeModal('employeeModal')">&times;</button>
        </div>
        <form onsubmit="saveEmployee(event)">
            <div class="form-group">
                <label>Employee ID</label>
                <input type="text" id="empId" placeholder="EMP001" required>
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="empName" placeholder="Full Name" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="empEmail" placeholder="email@example.com" required>
            </div>
            <div class="form-group">
                <label>Annual Salary</label>
                <input type="number" id="empSalary" placeholder="Amount" required>
            </div>
            <div class="form-group">
                <label>Shift</label>
                <select id="empShift" required>
                    <option>Shift A (12hr)</option>
                    <option>Shift B (12hr)</option>
                    <option>General (8hr)</option>
                </select>
            </div>
            <button type="submit" class="btn-full">Save Employee</button>
        </form>
    </div>
</div>

<!-- Attendance Modal -->
<div id="attendanceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Attendance</h2>
            <button class="close-btn" onclick="closeModal('attendanceModal')">&times;</button>
        </div>
        <form onsubmit="saveAttendance(event)">
            <div class="form-group">
                <label>Employee</label>
                <select id="attEmpId" required>
                    <option value="">Select Employee</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="attDate" required>
            </div>
            <div class="form-group">
                <label>In Time</label>
                <input type="time" id="attInTime" required>
            </div>
            <div class="form-group">
                <label>Out Time</label>
                <input type="time" id="attOutTime" required>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="attStatus" required>
                    <option>Present</option>
                    <option>Absent</option>
                    <option>Leave</option>
                    <option>Half Day</option>
                </select>
            </div>
            <button type="submit" class="btn-full">Save Attendance</button>
        </form>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Import Attendance</h2>
            <button class="close-btn" onclick="closeModal('importModal')">&times;</button>
        </div>
        <div class="form-group">
            <label>Upload CSV or Excel File</label>
            <input type="file" id="importFile" accept=".csv,.xlsx,.xls" required>
        </div>
        <button onclick="importAttendance()" class="btn-full">Import Data</button>
    </div>
</div>

<!-- User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add User</h2>
            <button class="close-btn" onclick="closeModal('userModal')">&times;</button>
        </div>
        <form onsubmit="saveUser(event)">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="userId" placeholder="username" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="userPassword" placeholder="password" required>
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="userRole" required>
                    <option>admin</option>
                    <option>user</option>
                </select>
            </div>
            <button type="submit" class="btn-full">Save User</button>
        </form>
    </div>
</div>

<script>
    // GLOBAL STATE
    let currentUser = null;
    let employees = [];
    let attendance = [];
    let payroll = [];
    let users = [];
    
    // Initialize
    window.addEventListener('load', () => {
        loadMockData();
        updateUI();
    });
    
    function loadMockData() {
        employees = [
            { id: 'EMP001', name: 'Rajesh Kumar', email: 'rajesh@company.com', salary: 480000, shift: 'Shift A (12hr)', active: true },
            { id: 'EMP002', name: 'Priya Singh', email: 'priya@company.com', salary: 360000, shift: 'Shift B (12hr)', active: true },
            { id: 'EMP003', name: 'Amit Patel', email: 'amit@company.com', salary: 300000, shift: 'General (8hr)', active: true },
            { id: 'EMP004', name: 'Neha Sharma', email: 'neha@company.com', salary: 420000, shift: 'Shift A (12hr)', active: true },
            { id: 'EMP005', name: 'Vikram Singh', email: 'vikram@company.com', salary: 240000, shift: 'General (8hr)', active: true }
        ];
        
        users = [
            { username: 'admin', password: 'admin123', role: 'admin', employeeId: null },
            { username: 'user1', password: 'pass123', role: 'user', employeeId: 'EMP001' },
            { username: 'user2', password: 'pass123', role: 'user', employeeId: 'EMP003' }
        ];
        
        // Mock 30 days attendance
        const today = new Date();
        for (let i = 0; i < 30; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            
            employees.forEach(emp => {
                if (Math.random() > 0.15) {
                    const inTime = `0${6 + Math.floor(Math.random() * 2)}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`;
                    const outTime = `18:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`;
                    
                    attendance.push({
                        employeeId: emp.id,
                        date: dateStr,
                        inTime: inTime,
                        outTime: outTime,
                        hours: 12,
                        status: 'Present'
                    });
                } else {
                    attendance.push({
                        employeeId: emp.id,
                        date: dateStr,
                        inTime: '',
                        outTime: '',
                        hours: 0,
                        status: 'Absent'
                    });
                }
            });
        }
    }
    
    function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const user = users.find(u => u.username === username && u.password === password);
        
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            updateUI();
        } else {
            document.getElementById('loginError').innerHTML = '<div class="error-message">Invalid credentials</div>';
        }
    }
    
    function logout() {
        currentUser = null;
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
    }
    
    function updateUI() {
        if (!currentUser) return;
        
        document.getElementById('userDisplay').textContent = `${currentUser.role.toUpperCase()} ‚Ä¢ ${currentUser.username}`;
        
        buildNavigation();
        showDashboard('employeeDashboard');
        updateEmployeeTable();
        updateAttendanceTable();
        updatePayrollTable();
        updateUsersTable();
        updateAnalytics();
        updateAttendanceSelect();
    }
    
    function buildNavigation() {
        const navMenu = document.getElementById('navMenu');
        navMenu.innerHTML = '';
        
        const dashboards = [
            { id: 'employeeDashboard', label: 'üë• Employees' },
            { id: 'attendanceDashboard', label: '‚è∞ Attendance' },
            { id: 'payrollDashboard', label: 'üí∞ Payroll' },
            { id: 'analyticsDashboard', label: 'üìà Analytics' },
            { id: 'cloudStorageDashboard', label: '‚òÅÔ∏è Cloud Storage' }
        ];
        
        if (currentUser.role === 'admin') {
            dashboards.push(
                { id: 'usersDashboard', label: 'üë§ Users' }
            );
        }
        
        dashboards.forEach(d => {
            const btn = document.createElement('button');
            btn.textContent = d.label;
            btn.onclick = () => showDashboard(d.id);
            navMenu.appendChild(btn);
        });
    }
    
    function showDashboard(dashboardId) {
        document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
        document.getElementById(dashboardId).classList.add('active');
    }
    
    function updateEmployeeTable() {
        const tbody = document.getElementById('employeeTable');
        tbody.innerHTML = employees.map(emp => `
            <tr>
                <td>${emp.id}</td>
                <td>${emp.name}</td>
                <td>${emp.email}</td>
                <td>‚Çπ${emp.salary.toLocaleString()}</td>
                <td>${emp.shift}</td>
                <td><button onclick="deleteEmployee('${emp.id}')" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">Delete</button></td>
            </tr>
        `).join('');
    }
    
    function updateAttendanceTable() {
        const tbody = document.getElementById('attendanceTable');
        tbody.innerHTML = attendance.slice(0, 30).map((att, idx) => {
            const emp = employees.find(e => e.id === att.employeeId);
            return `
                <tr>
                    <td>${emp?.name}</td>
                    <td>${att.date}</td>
                    <td>${att.inTime}</td>
                    <td>${att.outTime}</td>
                    <td>${att.hours}h</td>
                    <td><span class="status-badge status-${att.status.toLowerCase()}">${att.status}</span></td>
                    <td><button onclick="deleteAttendance(${idx})" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">Delete</button></td>
                </tr>
            `;
        }).join('');
    }
    
    function updatePayrollTable() {
        const tbody = document.getElementById('payrollTable');
        if (payroll.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No payroll generated</td></tr>';
            return;
        }
        tbody.innerHTML = payroll.map(p => {
            const emp = employees.find(e => e.id === p.employeeId);
            return `
                <tr>
                    <td>${emp?.name}</td>
                    <td>${p.month}/${p.year}</td>
                    <td>${p.daysWorked}</td>
                    <td>‚Çπ${p.grossPay.toLocaleString()}</td>
                    <td>‚Çπ${p.deductions.toLocaleString()}</td>
                    <td>‚Çπ${p.netPay.toLocaleString()}</td>
                    <td><button class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">View</button></td>
                </tr>
            `;
        }).join('');
    }
    
    function updateUsersTable() {
        const tbody = document.getElementById('usersTable');
        tbody.innerHTML = users.map(u => `
            <tr>
                <td>${u.username}</td>
                <td><span class="status-badge status-${u.role === 'admin' ? 'late' : 'present'}">${u.role}</span></td>
                <td><button onclick="deleteUser('${u.username}')" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">Delete</button></td>
            </tr>
        `).join('');
    }
    
    function updateAnalytics() {
        const today = new Date().toISOString().split('T')[0];
        const todayAttendance = attendance.filter(a => a.date === today);
        const presentCount = todayAttendance.filter(a => a.status === 'Present').length;
        const absentCount = todayAttendance.filter(a => a.status === 'Absent').length;
        const totalPresent = attendance.filter(a => a.status === 'Present').length;
        const avgAttendance = Math.round((totalPresent / attendance.length) * 100);
        
        document.getElementById('statTotalEmployees').textContent = employees.length;
        document.getElementById('statPresentToday').textContent = presentCount;
        document.getElementById('statAbsentToday').textContent = absentCount;
        document.getElementById('statAvgAttendance').textContent = avgAttendance + '%';
    }
    
    function updateAttendanceSelect() {
        const select = document.getElementById('attEmpId');
        select.innerHTML = '<option value="">Select Employee</option>' + employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
    }
    
    // Modal functions
    function showEmployeeModal() { document.getElementById('employeeModal').classList.add('active'); }
    function showAttendanceModal() {
        document.getElementById('attendanceModal').classList.add('active');
        document.getElementById('attDate').value = new Date().toISOString().split('T')[0];
    }
    function showUserModal() { document.getElementById('userModal').classList.add('active'); }
    function showImportModal() { document.getElementById('importModal').classList.add('active'); }
    function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
    
    function saveEmployee(e) {
        e.preventDefault();
        const emp = {
            id: document.getElementById('empId').value,
            name: document.getElementById('empName').value,
            email: document.getElementById('empEmail').value,
            salary: parseInt(document.getElementById('empSalary').value),
            shift: document.getElementById('empShift').value,
            active: true
        };
        employees.push(emp);
        updateEmployeeTable();
        updateAttendanceSelect();
        closeModal('employeeModal');
    }
    
    function saveAttendance(e) {
        e.preventDefault();
        const att = {
            employeeId: document.getElementById('attEmpId').value,
            date: document.getElementById('attDate').value,
            inTime: document.getElementById('attInTime').value,
            outTime: document.getElementById('attOutTime').value,
            status: document.getElementById('attStatus').value,
            hours: 0
        };
        
        if (att.inTime && att.outTime) {
            const inDate = new Date(`2000-01-01T${att.inTime}`);
            const outDate = new Date(`2000-01-01T${att.outTime}`);
            att.hours = Math.round((outDate - inDate) / (1000 * 60 * 60) * 10) / 10;
        }
        
        attendance.push(att);
        updateAttendanceTable();
        closeModal('attendanceModal');
    }
    
    function saveUser(e) {
        e.preventDefault();
        const user = {
            username: document.getElementById('userId').value,
            password: document.getElementById('userPassword').value,
            role: document.getElementById('userRole').value,
            employeeId: null
        };
        users.push(user);
        updateUsersTable();
        closeModal('userModal');
    }
    
    function deleteEmployee(empId) {
        if (confirm('Delete this employee?')) {
            employees = employees.filter(e => e.id !== empId);
            updateEmployeeTable();
        }
    }
    
    function deleteAttendance(idx) {
        if (confirm('Delete this record?')) {
            attendance.splice(idx, 1);
            updateAttendanceTable();
        }
    }
    
    function deleteUser(username) {
        if (confirm('Delete this user?')) {
            users = users.filter(u => u.username !== username);
            updateUsersTable();
        }
    }
    
    function generatePayroll() {
        const month = new Date().getMonth() + 1;
        const year = new Date().getFullYear();
        payroll = [];
        
        employees.forEach(emp => {
            const empAttendance = attendance.filter(a => a.employeeId === emp.id && a.status === 'Present');
            const totalHours = empAttendance.reduce((sum, a) => sum + (a.hours || 0), 0);
            const hourlyRate = emp.salary / 2080;
            const grossPay = totalHours * hourlyRate;
            const deductions = grossPay * 0.1;
            const netPay = grossPay - deductions;
            
            payroll.push({
                employeeId: emp.id,
                month: month,
                year: year,
                daysWorked: empAttendance.length,
                totalHours: totalHours,
                grossPay: Math.round(grossPay),
                deductions: Math.round(deductions),
                netPay: Math.round(netPay)
            });
        });
        
        updatePayrollTable();
        alert('Payroll generated!');
    }
    
    function importAttendance() {
        const file = document.getElementById('importFile').files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            const rows = text.split('\n');
            let imported = 0;
            
            rows.forEach((row, idx) => {
                if (idx === 0 || !row.trim()) return;
                const cols = row.split(',');
                if (cols.length >= 4) {
                    const emp = employees.find(e => e.name.toLowerCase().includes(cols[0].toLowerCase()));
                    if (emp) {
                        attendance.push({
                            employeeId: emp.id,
                            date: cols[1],
                            inTime: cols[2],
                            outTime: cols[3],
                            status: 'Present',
                            hours: 0
                        });
                        imported++;
                    }
                }
            });
            
            updateAttendanceTable();
            closeModal('importModal');
            alert('Imported ' + imported + ' records!');
        };
        reader.readAsText(file);
    }
    
    function backupToGoogleDrive() {
        const backup = {
            timestamp: new Date().toISOString(),
            employees: employees,
            attendance: attendance,
            payroll: payroll,
            users: users
        };
        
        const password = prompt('Enter backup password:');
        if (!password) return;
        
        const encrypted = CryptoJS.AES.encrypt(JSON.stringify(backup), password).toString();
        const blob = new Blob([encrypted], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `payroll_backup_${new Date().toISOString().split('T')[0]}.dat`;
        a.click();
        
        alert('‚úÖ Backup downloaded! Upload to Google Drive manually.');
    }
    
    function restoreFromGoogleDrive() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.dat';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const password = prompt('Enter backup password:');
                if (!password) return;
                
                try {
                    const decrypted = CryptoJS.AES.decrypt(event.target.result, password).toString(CryptoJS.enc.Utf8);
                    const backup = JSON.parse(decrypted);
                    
                    employees = backup.employees;
                    attendance = backup.attendance;
                    payroll = backup.payroll;
                    users = backup.users;
                    
                    updateUI();
                    alert('‚úÖ Data restored!');
                } catch (err) {
                    alert('‚ùå Invalid password or file');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
    
    window.onclick = (e) => {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('active');
        }
    };
</script>

</body>
</html>
